<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vaccine Outreach Reach Map</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- PapaParse (CSV parser) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --panel-bg: rgba(255, 255, 255, 0.92);
      --panel-border: rgba(0, 0, 0, 0.12);
      --shadow: 0 8px 22px rgba(0,0,0,0.18);
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Top title panel */
    .title-panel {
      position: absolute;
      z-index: 999;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 10px 14px;
      font-weight: 700;
      letter-spacing: 0.2px;
      text-align: center;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Legend panel */
    .legend {
      position: absolute;
      z-index: 999;
      bottom: 18px;
      left: 18px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      max-width: 260px;
    }
    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      opacity: 0.8;
    }
    .legend-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.12);
      flex: 0 0 auto;
    }

    /* Always-visible label styling */
    .site-label {
      background: white;
      border: 1px solid rgba(0,0,0,0.25);
      padding: 5px 7px;
      font-size: 11px;
      line-height: 1.25;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
      border-radius: 8px;
      white-space: nowrap;
    }
    .site-label strong {
      font-size: 11.5px;
    }

    /* Make tooltip pointer less prominent */
    .leaflet-tooltip-left:before,
    .leaflet-tooltip-right:before {
      border: none !important;
    }

    /* Optional: better for screenshots (keeps UI clean) */
    @media print {
      .title-panel, .legend { display: none; }
      #map { height: 100vh; }
    }
  </style>
</head>

<body>
  <div class="title-panel">Vaccine Education Outreach Map — Potential Monthly Reach (to date)</div>
  <div id="map"></div>

  <div class="legend" id="legend">
    <h4>Legend</h4>
    <div class="legend-row"><span class="swatch" style="background:#2E7D32"></span>Restaurant</div>
    <div class="legend-row"><span class="swatch" style="background:#1565C0"></span>Store</div>
    <div class="legend-row"><span class="swatch" style="background:#6A1B9A"></span>Non-profit Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#EF6C00"></span>Religious Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#455A64"></span>Other / Unknown</div>
    <div style="margin-top:8px; opacity:0.85;">
      Labels are always visible (no hover/click). “~” indicates estimated reach.
    </div>
  </div>

  <script>
    // ✅ IMPORTANT:
    // This is your CSV filename. It must be in the SAME folder as index.html in your GitHub repo.
    // Your filename contains spaces, so we use URL encoding for the spaces.
    const CSV_FILE = "vaccinetrack.csv";

    // Color by Type
    const typeColor = (t) => {
      const type = (t || "").trim().toLowerCase();
      if (type === "restaurant") return "#2E7D32";
      if (type === "store") return "#1565C0";
      if (type === "non-profit organization" || type === "nonprofit organization") return "#6A1B9A";
      if (type === "religous organization" || type === "religious organization") return "#EF6C00"; // handles misspelling too
      return "#455A64";
    };

    // Initialize map
    const map = L.map("map", { zoomControl: true }).setView([44.79, -91.46], 11);

    // Basemap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Parse & add points
    Papa.parse(CSV_FILE, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const rows = results.data || [];
        const bounds = [];

        const marker = L.circleMarker([lat, lng], {
          radius: 6,
          color: color,
          weight: 2,
          fillColor: color,
          fillOpacity: 0.95
        }).addTo(map);

        marker.bindTooltip(labelHtml, {
          permanent: true,
          direction: "right",
          offset: [10, 0],
          opacity: 1,
          className: "site-label"
        });
        
        // ✅ ADD THIS LINE
        markers.push(marker);

        rows.forEach((r) => {
          const name = (r["Institution"] || "").trim();
          const type = (r["Type"] || "").trim();
          const address = (r["Address"] || "").trim();

          // Accept both numeric and string
          const lat = parseFloat(r["Latitude"]);
          const lng = parseFloat(r["Longitude"]);

          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const reach = (r["Potential Reach (Monthly)"] || "").toString().trim();
          const en = (r["English"] || "").toString().trim();
          const es = (r["Spanish"] || "").toString().trim();
          const other = (r["Other"] || "").toString().trim();

          const color = typeColor(type);

          const marker = L.circleMarker([lat, lng], {
            radius: 6,
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.95
          }).addTo(map);

          // Always-visible label (no hover/click required)
          const labelHtml = `
            <strong>${escapeHtml(name || "Unknown site")}</strong><br>
            ${escapeHtml(type || "Other / Unknown")}<br>
            ${address ? escapeHtml(address) + "<br>" : ""}
            <span><b>Reach:</b> ${escapeHtml(reach || "N/A")}</span><br>
            <span><b>EN:</b> ${escapeHtml(en || "N/A")} &nbsp; <b>ES:</b> ${escapeHtml(es || "N/A")} &nbsp; <b>Other:</b> ${escapeHtml(other || "0")}</span>
          `.trim();

          marker.bindTooltip(labelHtml, {
            permanent: true,
            direction: "right",
            offset: [10, 0],
            opacity: 1,
            className: "site-label"
          });

          bounds.push([lat, lng]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [30, 30] });
        }
        function updateLabelVisibility() {
  const zoom = map.getZoom();

  markers.forEach(marker => {
    if (zoom >= 12) {
      marker.openTooltip();   // show labels
    } else {
      marker.closeTooltip();  // hide labels
    }
  });
}

// Run once on load
updateLabelVisibility();

// Update whenever zoom changes
map.on("zoomend", updateLabelVisibility);
      },
      error: (err) => {
        console.error("CSV load error:", err);
        alert("Could not load the CSV. Make sure the CSV file is in the same folder as index.html and the name matches exactly.");
      }
    });

    // Simple HTML escape to keep tooltips safe/clean
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
