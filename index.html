<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vaccine Education Outreach Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


  <!-- PapaParse (CSV parser) -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --panel-bg: rgba(255, 255, 255, 0.92);
      --panel-border: rgba(0, 0, 0, 0.12);
      --shadow: 0 8px 22px rgba(0,0,0,0.18);
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Top title panel */
    .title-panel {
      position: absolute;
      z-index: 999;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 10px 14px;
      font-weight: 800;
      letter-spacing: 0.2px;
      text-align: center;
      max-width: 92vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Legend panel */
    .legend {
      position: absolute;
      z-index: 999;
      bottom: 18px;
      left: 18px;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.35;
      max-width: 290px;
    }
    .legend h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
      opacity: 0.8;
    }
    .legend-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
    }
    .swatch {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 2px solid rgba(0,0,0,0.12);
      flex: 0 0 auto;
    }
    .legend .note {
      margin-top: 8px;
      opacity: 0.85;
    }

    /* Draggable label box */
    .label-box {
      background: white;
      border: 1px solid rgba(0,0,0,0.25);
      padding: 6px 8px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      font-size: 11px;
      line-height: 1.25;
      white-space: normal;
      width: 240px;           /* adjust if you want smaller boxes */
      cursor: grab;
      user-select: none;
    }
    .label-box:active { cursor: grabbing; }
    .label-box strong { font-size: 11.5px; }

    /* Make divIcon labels not add default marker padding */
    .leaflet-div-icon {
      background: transparent;
      border: none;
    }
  </style>
</head>

<body>
  <div class="title-panel">Vaccine Education Outreach Map — Potential Monthly Reach (to date)</div>
  <div id="map"></div>

  <div class="legend" id="legend">
    <h4>Legend</h4>
    <div class="legend-row"><span class="swatch" style="background:#2E7D32"></span>Restaurant</div>
    <div class="legend-row"><span class="swatch" style="background:#1565C0"></span>Store</div>
    <div class="legend-row"><span class="swatch" style="background:#6A1B9A"></span>Non-profit Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#EF6C00"></span>Religious Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#455A64"></span>Other / Unknown</div>
    <div class="note">
      Zoom in to see labels (no hover/click). Drag labels to reposition; leader lines stay connected. “~” indicates estimated reach.
    </div>
  </div>

  <script>
    // Your CSV must be in the SAME folder as index.html
    const CSV_FILE = "vaccinetrack.csv";

    // Label visibility zoom threshold (change if desired)
    const LABEL_ZOOM_THRESHOLD = 12;

    // Store objects: { point, label, line, siteLatLng }
    const markerObjects = [];

    // Color by Type
    function typeColor(t) {
      const type = (t || "").trim().toLowerCase();
      if (type === "restaurant") return "#2E7D32";
      if (type === "store") return "#1565C0";
      if (type === "non-profit organization" || type === "nonprofit organization") return "#6A1B9A";
      if (type === "religous organization" || type === "religious organization") return "#EF6C00"; // handles misspelling
      return "#455A64";
    }

    // Initialize map
    const map = L.map("map", { zoomControl: true }).setView([44.79, -91.46], 11);

    // Basemap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Helper: convert pixel offset from a LatLng to a new LatLng at current zoom
    function offsetLatLng(baseLatLng, offsetPx) {
      const p = map.latLngToLayerPoint(baseLatLng);
      const p2 = L.point(p.x + offsetPx[0], p.y + offsetPx[1]);
      return map.layerPointToLatLng(p2);
    }

    // Show/hide labels + leader lines based on zoom
    function updateLabelVisibility() {
      const zoom = map.getZoom();
      const show = zoom >= LABEL_ZOOM_THRESHOLD;

      markerObjects.forEach(obj => {
        if (show) {
          if (!map.hasLayer(obj.label)) obj.label.addTo(map);
          if (!map.hasLayer(obj.line)) obj.line.addTo(map);
        } else {
          if (map.hasLayer(obj.label)) map.removeLayer(obj.label);
          if (map.hasLayer(obj.line)) map.removeLayer(obj.line);
        }
      });
    }

    // Keep leader lines attached after zoom (and in general)
    function refreshLeaderLines() {
      markerObjects.forEach(obj => {
        // siteLatLng doesn't change; label may have moved
        obj.line.setLatLngs([obj.siteLatLng, obj.label.getLatLng()]);
      });
    }

    // Load CSV and create points + draggable labels
    Papa.parse(CSV_FILE, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const rows = results.data || [];
        const bounds = [];

        rows.forEach((r, i) => {
          const name = (r["Institution"] || "").trim();
          const type = (r["Type"] || "").trim();
          const address = (r["Address"] || "").trim();

          const lat = parseFloat(r["Latitude"]);
          const lng = parseFloat(r["Longitude"]);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const reach = (r["Potential Reach (Monthly)"] || "").toString().trim();
          const en = (r["English"] || "").toString().trim();
          const es = (r["Spanish"] || "").toString().trim();
          const other = (r["Other"] || "").toString().trim();

          const color = typeColor(type);
          const siteLatLng = L.latLng(lat, lng);

          // --- Point marker (always visible) ---
          const point = L.circleMarker([lat, lng], {
            radius: 6,
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.95
          }).addTo(map);

          // --- Draggable label content ---
          const labelHtml = `
            <div class="label-box">
              <strong>${escapeHtml(name || "Unknown site")}</strong><br>
              ${escapeHtml(type || "Other / Unknown")}<br>
              ${address ? escapeHtml(address) + "<br>" : ""}
              <b>Reach:</b> ${escapeHtml(reach || "N/A")}<br>
              <b>EN:</b> ${escapeHtml(en || "N/A")}
              &nbsp; <b>ES:</b> ${escapeHtml(es || "N/A")}
              &nbsp; <b>Other:</b> ${escapeHtml(other || "0")}
            </div>
          `.trim();

          // Initial label offsets to reduce collisions (fan out by index)
          const offsetCycle = [
            [90, 0],     // right
            [-260, 0],   // left
            [0, -120],   // up
            [0, 120],    // down
            [140, -90],  // up-right
            [-300, -90], // up-left
            [140, 90],   // down-right
            [-300, 90]   // down-left
          ];
          const initialOffsetPx = offsetCycle[i % offsetCycle.length];
          const labelLatLng = offsetLatLng(siteLatLng, initialOffsetPx);

          // --- Draggable label marker (shown only when zoomed in) ---
          const label = L.marker(labelLatLng, {
            draggable: true,
            interactive: true,
            icon: L.divIcon({
              className: "",
              html: labelHtml
            })
          });

          // --- Leader line (shown only when zoomed in) ---
          const line = L.polyline([siteLatLng, labelLatLng], {
            weight: 1.5,
            opacity: 0.7
          });

          // Update the line while dragging the label
          label.on("drag", () => {
            line.setLatLngs([siteLatLng, label.getLatLng()]);
          });

          // Save for zoom-based visibility + refresh logic
          markerObjects.push({ point, label, line, siteLatLng });

          // bounds for fit
          bounds.push([lat, lng]);
        });

        if (bounds.length) {
          map.fitBounds(bounds, { padding: [30, 30] });
        }

        // After fitBounds, apply zoom-based label visibility
        updateLabelVisibility();
        refreshLeaderLines();
      },
      error: (err) => {
        console.error("CSV load error:", err);
        alert("Could not load the CSV. Make sure vaccinetrack.csv is in the same folder as index2.html and the name matches exactly.");
      }
    });

    // Update labels on zoom
    map.on("zoomend", () => {
      updateLabelVisibility();
      refreshLeaderLines();
    });

    // Simple HTML escape
    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
