<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vaccine Education Outreach Map</title>

  <!-- Leaflet (no integrity hashes to avoid silent loading failures) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --panel-bg: rgba(255,255,255,0.92);
      --panel-border: rgba(0,0,0,0.12);
      --shadow: 0 8px 22px rgba(0,0,0,0.18);
    }
    html, body { height:100%; margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
    #map { height:100vh; width:100%; }

    .title-panel{
      position:absolute; z-index:999;
      top:14px; left:50%; transform:translateX(-50%);
      background:var(--panel-bg); border:1px solid var(--panel-border);
      border-radius:12px; box-shadow:var(--shadow);
      padding:10px 14px; font-weight:800;
      max-width:92vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      text-align:center;
    }

    .legend{
      position:absolute; z-index:999; bottom:18px; left:18px;
      background:var(--panel-bg); border:1px solid var(--panel-border);
      border-radius:12px; box-shadow:var(--shadow);
      padding:10px 12px; font-size:12px; line-height:1.35; max-width:340px;
    }
    .legend h4{ margin:0 0 8px 0; font-size:12px; text-transform:uppercase; opacity:0.8; letter-spacing:0.2px; }
    .legend-row{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .swatch{ width:10px; height:10px; border-radius:50%; border:2px solid rgba(0,0,0,0.12); }
    .legend .note{ margin-top:8px; opacity:0.85; }

    /* Draggable label box */
    .label-box{
      background:white;
      border:1px solid rgba(0,0,0,0.25);
      padding:6px 8px;
      border-radius:10px;
      box-shadow:0 2px 10px rgba(0,0,0,0.25);
      font-size:11px;
      line-height:1.25;
      width:240px;
      white-space:normal;
      cursor:grab;
      user-select:none;
    }
    .label-box:active{ cursor:grabbing; }
    .label-box strong{ font-size:11.5px; }

    /* Leaflet divIcon reset */
    .leaflet-div-icon{ background:transparent; border:none; }

    /* Toggle control button */
    .toggle-control{
      background:var(--panel-bg);
      border:1px solid var(--panel-border);
      border-radius:12px;
      box-shadow:var(--shadow);
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .toggle-sub{
      margin-top:4px;
      font-weight:500;
      font-size:11px;
      opacity:0.8;
    }
  </style>
</head>

<body>
  <div class="title-panel">Vaccine Education Outreach Map — Potential Monthly Reach (to date)</div>
  <div id="map"></div>

  <div class="legend">
    <h4>Legend</h4>
    <div class="legend-row"><span class="swatch" style="background:#2E7D32"></span>Restaurant</div>
    <div class="legend-row"><span class="swatch" style="background:#1565C0"></span>Store</div>
    <div class="legend-row"><span class="swatch" style="background:#6A1B9A"></span>Non-profit Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#EF6C00"></span>Religious Organization</div>
    <div class="legend-row"><span class="swatch" style="background:#455A64"></span>Other / Unknown</div>
    <div class="note">
      Click a dot to show/hide its label. Drag labels to reposition. “~” indicates estimated reach.
    </div>
  </div>

  <script>
    const CSV_FILE = "vaccinetrack.csv";

    // All site objects stored here:
    // { point, label, line, siteLatLng, color, visible }
    const sites = [];
    let allVisible = false;

    function typeColor(t){
      const type = (t || "").trim().toLowerCase();
      if (type === "restaurant") return "#2E7D32";
      if (type === "store") return "#1565C0";
      if (type === "non-profit organization" || type === "nonprofit organization") return "#6A1B9A";
      if (type === "religous organization" || type === "religious organization") return "#EF6C00"; // handles misspelling
      return "#455A64";
    }

    const map = L.map("map", { zoomControl:true }).setView([44.79, -91.46], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    // Control button (top-right): Show all / Hide all
    const ToggleControl = L.Control.extend({
      options: { position: "topright" },
      onAdd: function(){
        const div = L.DomUtil.create("div", "toggle-control");
        div.id = "toggleAll";
        div.innerHTML = `Show all labels<div class="toggle-sub">or click dots individually</div>`;

        // prevent clicks from dragging the map
        L.DomEvent.disableClickPropagation(div);
        L.DomEvent.on(div, "click", () => {
          allVisible = !allVisible;
          if (allVisible) {
            sites.forEach(s => showSiteLabel(s, true));
            div.innerHTML = `Hide all labels<div class="toggle-sub">or click dots individually</div>`;
          } else {
            sites.forEach(s => hideSiteLabel(s));
            div.innerHTML = `Show all labels<div class="toggle-sub">or click dots individually</div>`;
          }
        });
        return div;
      }
    });
    map.addControl(new ToggleControl());

    // Helper: pixel offset near dot -> LatLng
    function offsetLatLng(baseLatLng, offsetPx){
      const p = map.latLngToLayerPoint(baseLatLng);
      const p2 = L.point(p.x + offsetPx[0], p.y + offsetPx[1]);
      return map.layerPointToLatLng(p2);
    }

    // Show label+line for a site, positioning label next to dot if requested
    function showSiteLabel(site, snapNextToDot=false){
      if (snapNextToDot) {
        // Put the label near the dot (slightly to the right)
        const near = offsetLatLng(site.siteLatLng, [90, 0]);
        site.label.setLatLng(near);
      }
      if (!map.hasLayer(site.label)) site.label.addTo(map);
      if (!map.hasLayer(site.line)) site.line.addTo(map);

      // ensure line connects to current label location
      site.line.setLatLngs([site.siteLatLng, site.label.getLatLng()]);
      site.visible = true;
    }

    function hideSiteLabel(site){
      if (map.hasLayer(site.label)) map.removeLayer(site.label);
      if (map.hasLayer(site.line)) map.removeLayer(site.line);
      site.visible = false;
    }

    // Keep leader lines attached after zoom / pan
    function refreshLeaderLines(){
      sites.forEach(site => {
        if (site.visible) {
          site.line.setLatLngs([site.siteLatLng, site.label.getLatLng()]);
        }
      });
    }
    map.on("zoomend", refreshLeaderLines);
    map.on("moveend", refreshLeaderLines);

    Papa.parse(CSV_FILE, {
      download: true,
      header: true,
      skipEmptyLines: true,
      complete: (results) => {
        const rows = results.data || [];
        const bounds = [];

        rows.forEach((r, i) => {
          const name = (r["Institution"] || "").trim();
          const type = (r["Type"] || "").trim();
          const address = (r["Address"] || "").trim();
          const lat = parseFloat(r["Latitude"]);
          const lng = parseFloat(r["Longitude"]);
          if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

          const reach = (r["Potential Reach (Monthly)"] || "").toString().trim();
          const en = (r["English"] || "").toString().trim();
          const es = (r["Spanish"] || "").toString().trim();
          const other = (r["Other"] || "").toString().trim();

          const color = typeColor(type);
          const siteLatLng = L.latLng(lat, lng);

          // dot
          const point = L.circleMarker([lat, lng], {
            radius: 6,
            color: color,
            weight: 2,
            fillColor: color,
            fillOpacity: 0.95
          }).addTo(map);

          // label html
          const labelHtml = `
            <div class="label-box">
              <strong>${escapeHtml(name || "Unknown site")}</strong><br>
              ${escapeHtml(type || "Other / Unknown")}<br>
              ${address ? escapeHtml(address) + "<br>" : ""}
              <b>Reach:</b> ${escapeHtml(reach || "N/A")}<br>
              <b>EN:</b> ${escapeHtml(en || "N/A")}
              &nbsp; <b>ES:</b> ${escapeHtml(es || "N/A")}
              &nbsp; <b>Other:</b> ${escapeHtml(other || "0")}
            </div>
          `.trim();

          // initial label position near dot (but hidden until click/show-all)
          const initialOffsetCycle = [
            [90, 0], [-260, 0], [0, -120], [0, 120],
            [140, -90], [-300, -90], [140, 90], [-300, 90]
          ];
          const initialOffset = initialOffsetCycle[i % initialOffsetCycle.length];
          const labelLatLng = offsetLatLng(siteLatLng, initialOffset);

          const label = L.marker(labelLatLng, {
            draggable: true,
            interactive: true,
            icon: L.divIcon({ className: "", html: labelHtml })
          });

          // leader line matches dot color ✅
          const line = L.polyline([siteLatLng, labelLatLng], {
            weight: 2,
            opacity: 0.75,
            color: color
          });

          // Update line while dragging label
          label.on("drag", () => {
            line.setLatLngs([siteLatLng, label.getLatLng()]);
          });

          const siteObj = { point, label, line, siteLatLng, color, visible: false };
          sites.push(siteObj);

          // click dot toggles label, snapping it next to dot when opening
          point.on("click", () => {
            if (siteObj.visible) {
              hideSiteLabel(siteObj);
              // if any single is hidden, "all visible" is no longer true
              allVisible = false;
              const btn = document.getElementById("toggleAll");
              if (btn) btn.innerHTML = `Show all labels<div class="toggle-sub">or click dots individually</div>`;
            } else {
              showSiteLabel(siteObj, true); // ✅ open next to dot
            }
          });

          // Also allow clicking the label itself to close
          label.on("click", () => {
            hideSiteLabel(siteObj);
            allVisible = false;
            const btn = document.getElementById("toggleAll");
            if (btn) btn.innerHTML = `Show all labels<div class="toggle-sub">or click dots individually</div>`;
          });

          bounds.push([lat, lng]);
        });

        if (bounds.length){
          map.fitBounds(bounds, { padding: [30, 30] });
        }
      },
      error: (err) => {
        console.error("CSV load error:", err);
        alert("Could not load vaccinetrack.csv. Make sure it is in the same folder as index.html on GitHub Pages.");
      }
    });

    function escapeHtml(str){
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
